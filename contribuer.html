

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Frise Santé Publique - Dynamique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: #fdfdf0; }
    .years-column, .events-column, .fiche-column { padding: 1rem; overflow-y: auto; }
    .years-column { width: 120px; border-right: 1px solid #ccc; background: white; }
    .events-column { flex: 2; background: #fafafa; }
    .fiche-column { flex: 1; background: #fff; border-left: 1px solid #ccc; }

    .year { cursor: pointer; padding: 0.5rem; }
    .year.active { font-weight: bold; color: #007b7f; }

    .event { background: white; border: 1px solid #ccc; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; }
    .event.nearby { opacity: 0.6; font-style: italic; }
    .pluriannuel-badge { background: #007b7f; color: white; padding: 2px 6px; font-size: 0.7rem; margin-left: 6px; border-radius: 3px; }

    .keyword { color: #007bff; cursor: pointer; text-decoration: underline; }

    #filters { padding: 1rem; border-bottom: 1px solid #ccc; background: #f0f0f0; }
    #filters label { margin-right: 0.5rem; display: inline-block; }
  </style>
</head>
<body>
  <div class="years-column" id="year-column"></div>
  <div class="events-column">
    <div id="filters">
      <div><strong>Catégories :</strong> <span id="filter-categories"></span></div>
      <div><strong>Thèmes :</strong> <span id="filter-themes"></span></div>
      <div><strong>Mots-clés :</strong> <span id="filter-keywords"></span></div>
    </div>
    <div id="event-list"></div>
  </div>
  <div class="fiche-column">
    <h3 id="fiche-titre">Détails</h3>
    <div id="fiche-content">Cliquez sur un événement pour voir les détails.</div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const yearCol = document.getElementById("year-column");
  const eventList = document.getElementById("event-list");
  const ficheTitre = document.getElementById("fiche-titre");
  const ficheContent = document.getElementById("fiche-content");

  const catFilterBox = document.getElementById("filter-categories");
  const themeFilterBox = document.getElementById("filter-themes");
  const keywordFilterBox = document.getElementById("filter-keywords");

  let currentYear = null;
  let eventsData = [];
  let themeColors = {};

  fetch("events.json")
    .then(res => res.json())
    .then(data => {
      eventsData = data;

      const allYears = [...new Set(data.flatMap(e => {
        const start = parseInt(e.start);
        const end = parseInt(e.end);
        return Array.from({length: end - start + 1}, (_, i) => start + i);
      }))].sort((a, b) => a - b);

      allYears.forEach(y => {
        const yEl = document.createElement("div");
        yEl.className = "year";
        yEl.dataset.year = y;
        yEl.textContent = y;
        yEl.onclick = () => {
          document.querySelectorAll(".year").forEach(e => e.classList.remove("active"));
          yEl.classList.add("active");
          currentYear = parseInt(y);
          renderEvents();
        };
        yearCol.appendChild(yEl);
      });

      const categories = new Set();
      const themes = new Set();
      const keywords = new Set();

      data.forEach(e => {
        categories.add(e.maincat);
        categories.add(e.subcat);
        themes.add(e.themes);
        e.keywords.split(",").forEach(k => keywords.add(k.trim()));
      });

      [...themes].forEach((t, i) => {
        const hue = (i * 47) % 360;
        themeColors[t] = `hsl(${hue}, 70%, 50%)`;
      });

      function buildFilter(set, container, name) {
        [...set].forEach(val => {
          const id = `${name}-${val.replace(/\s+/g, "-")}`;
          const label = document.createElement("label");
          label.innerHTML = `<input type="checkbox" value="${val}" id="${id}" onchange="loadFilteredEvents()"> ${val}`;
          container.appendChild(label);
        });
      }

      buildFilter(categories, catFilterBox, "cat");
      buildFilter(themes, themeFilterBox, "theme");
      buildFilter(keywords, keywordFilterBox, "kw");

      window.filterByKeyword = function (kw) {
        const id = `kw-${kw.replace(/\s+/g, "-")}`;
        const box = document.getElementById(id);
        if (box) {
          box.checked = true;
          renderEvents();
        }
      };

      window.loadFilteredEvents = renderEvents;

      function renderEvents() {
        eventList.innerHTML = "";

        const range = [currentYear - 2, currentYear - 1, currentYear, currentYear + 1, currentYear + 2];

        const activeCats = [...catFilterBox.querySelectorAll("input:checked")].map(i => i.value);
        const activeThemes = [...themeFilterBox.querySelectorAll("input:checked")].map(i => i.value);
        const activeKeywords = [...keywordFilterBox.querySelectorAll("input:checked")].map(i => i.value);

        const filtered = eventsData.filter(e => {
          const inCat = activeCats.length === 0 || activeCats.includes(e.maincat) || activeCats.includes(e.subcat);
          const inTheme = activeThemes.length === 0 || activeThemes.includes(e.themes);
          const inKw = activeKeywords.length === 0 || activeKeywords.some(k => e.keywords.includes(k));
          return inCat && inTheme && inKw;
        });

        filtered.forEach(e => {
          const inRange = currentYear >= e.start && currentYear <= e.end;
          const nearby = !inRange && range.some(y => y >= e.start && y <= e.end);
          if (!inRange && !nearby) return;

          const ev = document.createElement("div");
          ev.className = "event" + (nearby ? " nearby" : "");
          ev.innerHTML = `
            <div class="event-date">${currentYear}</div>
            <div>
              <span style="background:${themeColors[e.themes]}; width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px;"></span>
              <strong>${e.title}${e.start != e.end ? ` (${e.start}–${e.end})` : ""}</strong>
              ${e.start != e.end ? `<span class="pluriannuel-badge">Pluriannuel</span>` : ""}
            </div>
          `;
          ev.onclick = () => {
            ficheTitre.textContent = `${e.title} (${e.start} – ${e.end})`;
            ficheContent.innerHTML = `
              <p><strong>Catégories :</strong> ${e.maincat} / ${e.subcat}</p>
              <p><strong>Thèmes :</strong> ${e.themes}</p>
              <p><strong>Mots-clés :</strong> ${e.keywords.split(",").map(k => `<span class="keyword" onclick="filterByKeyword('${k.trim()}')">${k.trim()}</span>`).join(", ")}</p>
              <p>${e.description}</p>
              ${e.source ? `<p><a href="${e.source}" target="_blank">Source</a></p>` : ""}
            `;
          };
          eventList.appendChild(ev);
        });
      }
    });
});
</script>
</body>
</html>
